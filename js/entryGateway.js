var app,table,areaLoadedId=0,areaProperty="",overlays=[],entry="gateway",gatewayMarker="",center="",map="",resize=!1,setup={bindActions:function(){$(".entry-action").click(function(){switch($(this).data("action")){case"addOpen":render.switchTop();break;case"addCancel":render.switchTop(),setup.clearMap();break;case"submit":entryUtil.validateFields()&&entryUtil.entryCrud(entry,"submit");break;case"selectGeoref":$("#add-marker").show(),$("#delete-marker").hide(),$("#georef-modal").modal("show"),setup.bindLatLngFields();break;default:console.log("Entry Action UNDEFINED")}})},populateSelects:function(){},bindLatLngFields:function(){setTimeout(function(){$("#georefs").find("input").removeAttr("disabled"),$("#georefs").find("input").unbind("blur").bind("blur",function(){var e=$($("#georefs").find("input")[0]).val(),a=$($("#georefs").find("input")[1]).val();if(""!=a&&""!=e){var t={lat:parseFloat(e.replace(",",".")),lng:parseFloat(a.replace(",","."))};gatewayMarker&&null!=gatewayMarker&&gatewayMarker.setMap(null),gatewayMarker=null,(gatewayMarker=setup.addMarker(t)).setMap(map),$("#delete-marker").show(),$("#add-marker").hide()}})},1e3)},bindTableActions:function(){$(".table-action").click(function(){switch($(this).data("action")){case"edit":setup.clearMap(),entryUtil.entryCrud(entry,"get",$(this).data("id"));break;case"delete":var e=$(this).data("id");app.notify("warning",$.t("notify.warning"),$.t("entry.deleteConfirm",{entry:$.t("Gateway")}),!0,function(a){a&&(entryUtil.entryCrud(entry,"delete",e),setup.clearMap())});break;default:console.log("Table Action UNDEFINED")}})},bindModalActions:function(){googleMapsFn.addCoordToModal($("#georefs").data("min")),$("#georef-modal").on("shown.bs.modal",function(){""!==$(".y:first").val()?googleMapsFn.lockCoords(!0):googleMapsFn.lockCoords(!1),setup.handleMap()}),$("#georef-modal").on("hidden.bs.modal",function(){googleMapsFn.changeGeorefModal("map")}),$('[data-action="addCoord"]').click(function(){googleMapsFn.addCoordToModal(1)}),$("#add-marker").click(function(){gatewayMarker=setup.addMarker(center),$("#delete-marker").show(),$("#add-marker").hide(),googleMapsFn.formFromPoint(center),gatewayMarker.setMap(map),$($("#georefs").find("input")[0]).removeAttr("disabled"),$($("#georefs").find("input")[1]).removeAttr("disabled")}),$("#delete-marker").click(function(){setup.deleteMarker()})},clearMap:function(){googleMapsFn.resetCoordModal($("#georefs").data("min")),googleMapsFn.lockCoords(!1),areaProperty&&(areaProperty.setMap(null),areaProperty=null),map=null,$("#map").html("")},handleMap:function(){map||setup.loadProperty()},loadProperty:function(){app.loadingAdd(),$.ajax({url:app.api+"api/property/georeferencing/"+localStorage.getItem("property_id"),type:"GET",beforeSend:app.setHeaders}).done(function(e){if(e.georeferencing){googleMapsFn.deleteOverlays(overlays),overlays=[];var a=e.georeferencing.coordinates.points,t=googleMapsFn.latLngFromPoints(a);center={lat:a[0].y,lng:a[0].x},map||(map=googleMapsFn.drawMap(center),setup.mapListeners()),setup.showProperty(t),setup.showGateway(),googleMapsFn.showOverlays(overlays,map)}else $("#map").html('<div class="text-center">'+$.t("property.emptyError")+"</div>")}).fail(function(e){app.ajaxError(e)}).always(function(){app.loadingRemove()})},showProperty:function(e){var a=googleMapsFn.drawPolygon(e,"#fdb560",0);a.setOptions({zIndex:0}),0===areaLoadedId&&(googleMapsFn.fitPolygon(a,map),areaProperty=a),overlays.push(a)},mapListeners:function(){google.maps.event.addDomListener(window,"resize",function(){resize=!0}),map.addListener("idle",function(){resize&&(googleMapsFn.fitPolygon(centerPolygon,map),resize=!1)})},showGateway:function(){gatewayMarker=setup.addMarker(googleMapsFn.latLngFromForm()[0]),""==$($("#georefs").find("input")[0]).val()?($("#delete-marker").hide(),$("#add-marker").show()):($("#delete-marker").show(),$("#add-marker").hide()),overlays.push(gatewayMarker)},addMarker:function(e){var a=new google.maps.Marker({position:e,icon:"images/icons/32-antenna.png",id:id,draggable:!0});return google.maps.event.addListener(a,"dragend",function(e){var t={lat:a.getPosition().lat(),lng:a.getPosition().lng()};googleMapsFn.formFromPoint(t),setup.bindLatLngFields(),$($("#georefs").find("input")[0]).removeAttr("disabled"),$($("#georefs").find("input")[1]).removeAttr("disabled")}),a},deleteMarker:function(){gatewayMarker&&null!=gatewayMarker&&gatewayMarker.setMap(null),gatewayMarker=null,$(".x:first").val(""),$(".y:first").val(""),$("#delete-marker").hide(),$("#add-marker").show()},tableSetup:function(){var e=[{data:"id",visible:!1,render:function(e){return app.htmlEncode(e)}},{data:"description",render:function(e){return e?app.htmlEncode(e):"-"}},{data:"altitude",render:function(e){return e?app.htmlEncode(e):"-"}},{data:"coordinate",render:function(e){return e?app.htmlEncode("("+e.x+";"+e.y+")"):"-"}},{data:"macAddress",render:function(e){return e?app.htmlEncode(e):"-"}},{data:null,render:function(e){return render.renderActions(e.id,e.id,e.locked)}}];entryUtil.tableLoad(e,!1)},init:function(e){console.log("entryGateway.js"),document.title=$.t("gateway.title"),app=e,this.bindActions(),this.bindModalActions(),this.tableSetup(),$("#add-marker").show(),$("#remove-marker").hide()}};