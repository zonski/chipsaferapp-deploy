var app,table,id=0,entry="buyAnimals",currencyMask="",filtroTeclas=function(a){return a.charCode>=48&&a.charCode<=57},setup={deviceList:[],bindActions:function(){$(".entry-action").click(function(){switch($(this).data("action")){case"addOpen":render.switchTop();break;case"addCancel":render.switchTop(),setup.setSelectValue(!1),setup.showOption(id,!0),id=0;break;case"submit":0==$("#buyList").DataTable().rows().count()?app.notify("warning",$.t("notify.warning"),$.t("buyAnimals.buyListEmpty"),!1,!1):entryUtil.validateFields("#entry-add")&&(submitCall=function(a){a&&entryUtil.entryCrud(entry,"submit","","#entry-add")},null==localStorage.getItem("transactionId")?app.notify("warning",$.t("notify.warning"),$.t("buyAnimals.saveConfirm"),!0,submitCall):app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saveConfirmUpdate"),!0,submitCall));break;default:console.log("Entry Action UNDEFINED")}})},bindTableActions:function(){$('span[data-action="addAnimal"]').click(function(){var a=$(this).data("id"),n=$("#buyList").DataTable(),e=!1;n.rows().every(function(n,t,i){this.data().animalId==a&&(app.notify("warning",$.t("notify.warning"),$.t("buyAnimals.enrolledAnimal"),!1,!1),e=!0)}),e||n.row.add({animalId:a,name:$(this).parents("tr").find("span")[1].innerHTML}).draw()})},tableLoad:function(a,n,e,t){$("#"+t).DataTable({lengthChange:!1,ordering:!1,info:!0,responsive:!1,serverSide:!0,paging:!0,searching:!0,dom:"ftip",language:{url:"locales/"+app.locale+"/translation.json"},ajax:{url:app.api+"api/"+a+"/list"+n,type:"POST",beforeSend:app.setHeaders,error:function(a){app.ajaxError(a)}},preDrawCallback:function(){app.loadingAdd()},drawCallback:function(){setup.bindTableActions(),app.loadingRemove()},initComplete:function(){$('input[type="search"]').attr("placeholder",$.t("entry.search")).attr("maxlength",50),$("#"+t).show()},columns:e})},getColumn:function(a){var n="<span>"+app.htmlEncode(a.code);return null!=a.code&&a.code.length>0?n+=a.nickName?app.htmlEncode(" - "+a.nickName):"":n+=a.nickName?app.htmlEncode(a.nickName):"",n+=a.subSpecies.name?app.htmlEncode(" ("+a.subSpecies.name):"",n+=a.pelage.name?app.htmlEncode(" - "+a.pelage.name):"",n+=" - ",1===a.gender?n+=$.t("animal.fields.genderMale"):2===a.gender&&(n+=$.t("animal.fields.genderFemale")),(n+=")")+"</span>"},tableSetup:function(){var a=[{data:"id",responsivePriority:1,render:function(a){return'<span data-action="addAnimal" data-id="'+a+'" style="cursor:pointer" class="icon icon-plus-alt"></span>'}},{data:null,render:function(a){return setup.getColumn(a)}}];setup.tableLoad(entry,"",a,"animalsList")},formatInputValue:function(a){$("#currency").val();var n=$("#currency").find(":selected").data("locale");return entryUtil.formatStringToCurrency(a,n,$("#currency").val())},populateSelects:function(){$("#currency").empty(),entryUtil.getJsonData("currency/GetAll/","GET").then(function(a){$.each(a,function(a,n){$("#currency").append($("<option>",{value:n.code,text:n.name,"data-mask":n.mask,"data-locale":n.locale,"data-id":n.id}))})}),entryUtil.getJsonData("customersupplier/getallforbuying/","GET").then(function(a){$.each(a,function(a,n){$("#supplier").append($("<option>",{value:n.id,text:n.name,"data-currencyMask":n.currencyMask,"data-currencyCode":n.currencyCode}))})})},buyingTable:function(){$("#buyList").DataTable({paging:!0,searching:!0,info:!1,autoWidth:!1,columns:[{data:"animalId",width:"5%",render:function(a){return'<span data-action="removeAnimal" data-id="'+a+'" style="cursor:pointer" class="glyphicon glyphicon-minus-sign"></span>'}},{data:"name",width:"75%",render:function(a){return"<span>"+a+"</span>"}},{data:"buyValue",width:"20%",render:function(a){return null==a&&(a=""),'<div style="float: right"><input type="text" name="buyValue" class="form-control field required "onkeypress="return filtroTeclas(event)" maxlength="20" value="'+a+'"></div>'}},{data:"id",visible:!1,render:function(a){return app.htmlEncode(a)}}],language:{url:"locales/"+app.locale+"/translation.json"},fixedHeader:{header:!0,footer:!0},drawCallback:function(){}}),$("#excludedItensList").DataTable({searching:!1,paging:!1,info:!1,oLanguage:{sEmptyTable:"",sZeroRecords:""},columns:[{data:"animalId",visible:!1,render:function(a){return'<span data-id="'+a+'"></span>'}},{data:"name",visible:!1,render:function(a){return"<span>"+a+"</span>"}},{data:"buyValue",visible:!1,render:function(a){return null==a&&(a=""),'<input type="text" name="buyValue" value="'+a+'">'}},{data:"id",visible:!1,render:function(a){return app.htmlEncode(a)}}]})},valuesSum:function(){var a=0;$('input[name="buyValue"]').each(function(){var n=$(this).val();n&&(a+=entryUtil.currencyToFloat(n))});var n={minimumFractionDigits:2,style:"currency",currency:$("#currency").val()},e=$("#currency").find(":selected").data("locale");$("#totalBuyingByAnimal").html(a.toLocaleString(e,n))},changeInputMask:function(){currencyMask=$("#currency").find(":selected").data("mask"),$('input[name="buyValue"]').mask(currencyMask,{reverse:!0})},loadData:function(a){$.ajax({url:app.api+"api/transaction/"+a,type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(a){if(trans=a,trans){var n=new Date(trans.dateTransaction);$("#buyingDate").val(n.toLocaleDateString(app.locale)),$("#supplier").val(trans.customerSupplierId),$("#currency").val(trans.currencyCode);var e=$("#buyList").DataTable();a.itens.forEach(function(a){e.row.add({id:a.id,animalId:a.animalId,name:a.animalDescription,buyValue:setup.formatInputValue(a.value)})}),e.draw()}}).fail(function(a){app.ajaxError(a)})},init:function(a){console.log("buyAnimals.js"),document.title=$.t("buyAnimals.title"),app=a,this.bindActions(),this.populateSelects(),this.tableSetup(),this.buyingTable(),$(document).ready(function(){if(null!=localStorage.getItem("transactionId"))setup.loadData(localStorage.getItem("transactionId")),setup.valuesSum(),$("#registerBuy").text($.t("buyAnimals.saveEdit"));else{$("#currency").val($("#supplier").find(":selected").data("currencycode"));var a={minimumFractionDigits:2,style:"currency",currency:$("#currency").val()},n=parseFloat($("#totalBuyingByAnimal").html().replace(/^\D+/g,"")),e=$("#currency").find(":selected").data("locale");$("#totalBuyingByAnimal").html(n.toLocaleString(e,a))}}),$(document).on("click",'input[name="buyValue"]',function(){setup.changeInputMask()}),$(document).on("focus",'input[name="buyValue"]',function(){setup.changeInputMask()}),$(document).on("click",'span[data-action="removeAnimal"]',function(){var a=$("#buyList").DataTable(),n=$("#excludedItensList").DataTable(),e=$(this).parents("tr")[0],t=$(e).find("td span")[0],i=$(e).find("td span")[1];e.lastElementChild.innerText&&n.row.add({id:e.lastElementChild.innerText,animalId:$(t).data("id"),name:$(i).html(),buyValue:$(e).find("input").val()}).draw(),a.row($(this).parents("tr")).remove().draw(),setup.valuesSum()}),$(document).on("click","#supplier",function(){currencyMask=$("#supplier").find(":selected").data("currencymask"),$("#currency").val($("#supplier").find(":selected").data("currencycode")),$('input[name="buyValue"]').mask(currencyMask,{reverse:!0})}),$(document).on("change","#currency",function(){setup.changeInputMask(),setup.valuesSum()}),$(document).on("blur",'input[name="buyValue"]',function(){$(this).val(setup.formatInputValue($(this).val())),setup.valuesSum()})}};