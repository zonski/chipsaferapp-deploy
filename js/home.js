var app,map="",area="",resize=!1,overlays=[],colorList=["#512525","#03722C","#06E052","#00ff3b"],setup={animalTrajectoryHistory:[],animalTrajectoryHistoryMarkers:[],animalTrajectoryHeatMap:null,propertyOverlay:null,overlayDictonary:[],arrayArea:[],loadAreas:function(e){app.loadingAdd(),$.ajax({url:app.api+"api/propertyGeolocation/"+e,type:"GET",beforeSend:app.setHeaders}).done(function(e){if(e.georeferencing){googleMapsFn.deleteOverlays(overlays),overlays=[],setup.overlayDictonary=[],setup.arrayArea=[];var a=e.georeferencing.coordinates.points,o={lat:a[0].y,lng:a[0].x},n=googleMapsFn.latLngFromPoints(a);map||(map=googleMapsFn.drawMap(o),setup.mapListeners()),n.length>2&&(setup.showProperty(n),setup.showArea(e.area),setup.overlayDictonary.push({key:"Area",icon:"polygon.png",value:setup.arrayArea})),showIndividualAnimals=e.animal&&e.animal.length,showIndividualAnimals?(setup.showAnimal(e.animal),setup.showGateway(e.gateway)):setup.showAreaSummaries(e.area),googleMapsFn.showOverlays(overlays,map),setup.buildLayerWindow()}else $("#map").html('<div class="text-center">'+$.t("property.emptyError")+"</div>")}).fail(function(e){app.ajaxError(e)}).always(function(){app.loadingRemove()})},buildLayerWindow:function(){var e,a,o,n=function(){this.getMap()?this.setMap(null):this.setMap(map)};$("#layerOptions").empty(),$.each(setup.overlayDictonary,function(t,r){r.value.latLngs?(r.value.toggleDOM=n,r.value.setMap(map)):Array.isArray(r.value)?(a=r.key.toLowerCase()+"Options",o=r.key.toLowerCase()+"Input",e='<div class="dropdown-submenu">',e+='<li href="#" class="dropdown-toggle" data-toggle="dropdown"',e+='role="button" aria-expanded="false"><img src="images/icons/'+r.icon+'">'+r.key+"</li>",e+='<ul id="'+a+'" class="dropdown-menu">',e+='<div class="inner-addon right-addon">',e+='<input type="text" class="dropdown-input" placeholder="'+$.t("entry.search")+'" id="'+o+'">',e+='<i class="material-icons">search</i></div></ul></div>',$("#layerOptions").append($(e)),$("#"+o).keyup(function(){console.log(this.id),setup.filterFunction(this.id)}),$.each(r.value,function(e,o){o.value.toggleDOM=n,o.value.setMap(map),$("#"+a).append($("<li onClick=\"setup.overlayToggle('"+o.key+"')\">"+o.name+"</li>"))})):$.each(r.value,function(e,a){a.toggleDOM=n,a.setMap(map)}),Array.isArray(r.value)||$("#layerOptions").append($("<li onClick=\"setup.overlayToggle('"+r.key+'\')"><img src="images/icons/'+r.icon+'">'+r.key+"</li>"))}),$(".dropdown-menu").click(function(e){e.stopPropagation()})},overlayToggle:function(e){$.each(setup.overlayDictonary,function(a,o){Array.isArray(o.value)?$.each(o.value,function(a,o){o.key==e&&o.value.toggleDOM()}):o.key==e&&(o.value.latLngs?o.value.toggleDOM():$.each(o.value,function(e,a){a.toggleDOM()}))})},filterFunction:function(e){var a,o,n;for(a=document.getElementById(""+e).value.toUpperCase(),o=document.getElementById(e.replace("Input","")+"Options").getElementsByTagName("li"),n=0;n<o.length;n++)txtValue=o[n].textContent||o[n].innerText,txtValue.toUpperCase().indexOf(a)>-1?o[n].style.display="":o[n].style.display="none"},mapListeners:function(){google.maps.event.addDomListener(window,"resize",function(){resize=!0}),map.addListener("idle",function(){resize&&(googleMapsFn.fitPolygon(area,map),resize=!1)})},showProperty:function(e){setup.propertyOverlay=googleMapsFn.drawPolygon(e,setup.getColor(0),0),setup.propertyOverlay.setOptions({zIndex:0}),googleMapsFn.fitPolygon(setup.propertyOverlay,map),area=setup.propertyOverlay,setup.propertyOverlay.addListener("click",setup.areaClick),setup.overlayDictonary.push({key:$.t("home-map.overlay-bar.property"),icon:"polygon.png",value:setup.propertyOverlay})},showAreaSummaries:function(e){$.each(e,function(e,a){this.georeferencing&&googleMapsFn.drawMarkerArea(this.georeferencing.coordinates.points,a.id,a.numAnimals)})},showArea:function(e){$.each(e,function(e,a){if(this.georeferencing){var o=googleMapsFn.latLngFromPoints(this.georeferencing.coordinates.points),n=googleMapsFn.drawPolygon(o,setup.getColor(this.levelHierarquical),this.id);n.setOptions({zIndex:this.levelHierarquical}),n.addListener("click",setup.areaClick),setup.arrayArea.push({key:$.t("home-map.overlay-bar.area")+" "+e,icon:"polygon.png",value:n,name:a.name}),setup.showArea(this.areaChildren),setup.showResource(this.resource)}})},toggleLayerBar:function(){$(".overlay-bar-badge").toggle(),$(".overlay-bar").toggle()},showAnimal:function(e){var a=[];$.each(e,function(e,o){var n="32-boi.png";"Bezerro"!=o.classification.name&&"Bezerra"!=o.classification.name||(n="32-bezerro.png");var t=googleMapsFn.latLngFromPoints([this.geolocation.coordinate]),r=googleMapsFn.drawMarkerAnimal(t[0],this.id,n,o.nickName,o.code,moment(o.geolocation.dateTimeEvent).format("DD/MM/YYYY HH:mm:ss")),i='<div id="content" class="dialog-marker-animal"><div id="bodyContent" class="bodyContent-animal"><p><span><img src="images/icons/Cow.png" style="width:25px"></span><span><b>'+o.nickName+" - "+o.code+'</b></span></p><p><span><i class="material-icons">av_timer</i></span><span>'+moment(o.geolocation.dateTimeEvent).format("DD/M/YYYY HH:mm:ss")+'</span></p><p style="margin: 13px;"><a href="javascript:setup.animalTrajectory('+o.id+');"><span><img src="images/icons/heatmap.png"></span><span>HeatMap</span></a></p><p><a href="https://www.google.com/maps/?q='+o.geolocation.coordinate.y+","+o.geolocation.coordinate.x+'" target="_blank"><span><i class="material-icons">map</i></span><span>('+o.geolocation.coordinate.x+","+o.geolocation.coordinate.y+")</span></a></p></div></div>",s=new google.maps.InfoWindow({content:i});r.addListener("click",function(){s.open(map,r)}),r.setOptions({zIndex:999}),a.push({key:$.t("home-map.overlay-bar.animals")+" "+e,icon:"32-boi.png",value:r,name:o.nickName+" - "+o.code})}),setup.overlayDictonary.push({key:$.t("home-map.overlay-bar.animals"),icon:"32-boi.png",value:a})},showGateway:function(e){var a=[];$.each(e,function(e,o){var n=googleMapsFn.latLngFromPoints([o.coordinate]),t=googleMapsFn.drawMarkerGateway(n[0],this.id,"32-antenna.png",o.description,o.altitude);t.setOptions({zIndex:999}),a.push({key:$.t("home-map.overlay-bar.gateway"),icon:"32-antenna.png",value:t,name:$.t("home-map.overlay-bar.gateway")+" "+e})}),setup.overlayDictonary.push({key:"Gateway",icon:"32-antenna.png",value:a})},showResource:function(e){$.each(e,function(){if(this.georeferencing&&this.georeferencing.coordinates){var e,a=googleMapsFn.latLngFromPoints(this.georeferencing.coordinates.points);"Polygon"==this.resourceModel.resourceType.geometryType?e=googleMapsFn.drawPolygon(a,"#FFA440",0):"Line"==this.resourceModel.resourceType.geometryType?e=googleMapsFn.drawPolyline(a,"#0FA3FF",3,0):"Point"==this.resourceModel.resourceType.geometryType&&(e=googleMapsFn.drawMarker(a,this.id,"32-arvore.png",this.code)),e.setOptions({zIndex:999}),overlays.push(e)}})},areaClick:function(){this.id?setup.loadArea(this.id):setup.loadArea(0)},getColor:function(e){var a=e<colorList.length?e:e%colorList.length;return colorList[a]},heatMapProperty:function(){$.ajax({url:app.api+"api/geolocation/getlast/50000",type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(e){console.log("data",e);var a=[];googleMapsFn.deleteOverlays(setup.animalTrajectoryHistory),googleMapsFn.deleteOverlays(setup.animalTrajectoryHistoryMarkers),$.each(e,function(e,o){0!=o.y&&o.y<0&&a.push(new google.maps.LatLng(o.y.toFixed(6),o.x.toFixed(6)))}),setup.animalTrajectoryHeatMap=new google.maps.visualization.HeatmapLayer({data:a,map:map}),setup.animalTrajectoryHeatMap.setMap(map)}).fail(function(e){app.ajaxError(e)}).always(function(){app.loadingRemove()})},animalTrajectory:function(e){var a=time.nextYear()+"-01-01";if(null!=setup.animalTrajectoryHeatMap)return setup.animalTrajectoryHeatMap.setMap(null),void(setup.animalTrajectoryHeatMap=null);app.loadingAdd(),$.ajax({url:app.api+"api/animal/geolocations/2016-01-01/"+a+"/"+e,type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(e){var a=[];googleMapsFn.deleteOverlays(setup.animalTrajectoryHistory),googleMapsFn.deleteOverlays(setup.animalTrajectoryHistoryMarkers),$.each(e,function(e,o){0!=o.coordinate.y&&o.coordinate.y<0&&a.push(new google.maps.LatLng(o.coordinate.y.toFixed(6),o.coordinate.x.toFixed(6))),google.maps.SymbolPath.CIRCLE}),setup.animalTrajectoryHeatMap=new google.maps.visualization.HeatmapLayer({data:a}),setup.animalTrajectoryHeatMap.setMap(map)}).fail(function(e){app.ajaxError(e)}).always(function(){app.loadingRemove()})},init:function(e){console.log("home.js"),$(".overlay-bar-badge").show(),$(".overlay-bar").hide(),app=e,this.loadAreas(0),$(".overlay-bar-badge").css("visibility","visible")}};