var app,table,polyline,id,rowSelected,tableButton,entry="trajectory",map=null,areaProperty=null,overlays=[],resize=!1,trajectory=[],trajectories=[],setup={bindActions:function(){$(".entry-action").click(function(){switch($(this).data("action")){case"searchOpen":render.switchTop();break;case"searchClose":render.switchTop(),render.clearTrajectoryPeriod();break;case"backup":setup.backupAllTrajectories();break;case"filter":trajectoryUtil.tableLoad(columns);break;default:console.log("Entry Action UNDEFINED")}})},bindTableActions:function(){$(".table-action").click(function(){switch($(this).data("action")){case"animalMovement":tableButton=!0,$("#id").val($(this).data("id")),id=$(this).data("id"),rowSelected=$(this).closest("tr").index()+1,setup.loadAnimalGeoreference();break;case"downloadDataInPDF":id=$(this).data("id"),rowSelected=$(this).closest("tr").index()+1,setup.downloadData("pdf");break;case"downloadDataInXLSX":id=$(this).data("id"),rowSelected=$(this).closest("tr").index()+1,setup.downloadData("xlsx");break;default:console.log("Table Action UNDEFINED")}})},bindModalActions:function(){googleMapsFn.addCoordToModal($("#georefs").data("min")),$("#georef-modal").on("shown.bs.modal",function(){""!==$(".y:first").val()?googleMapsFn.lockCoords(!0):googleMapsFn.lockCoords(!1),overlays.length>0&&googleMapsFn.deleteOverlays(overlays),tableButton?(setup.loadProperty(),setup.showTrajectoryWindow()):(render.clearTrajectoryInfo(),setup.drawTrajectries()),googleMapsFn.showOverlays(overlays,map)})},loadProperty:function(){app.loadingAdd(),$.ajax({url:app.api+"api/property/"+localStorage.getItem("property_id"),type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(e){if(e.georeferencing){var a=e.georeferencing.coordinates.points,t={lat:a[0].y,lng:a[0].x},o=googleMapsFn.latLngFromPoints(a);map||(map=googleMapsFn.drawMap(t),setup.mapListeners()),setup.showProperty(o)}else $("#map").html('<div class="text-center">'+$.t("property.emptyError")+"</div>")}).fail(function(e){app.ajaxError(e)}).always(function(){app.loadingRemove()})},showProperty:function(e){var a=googleMapsFn.drawPolygon(e,"#512525",0);a.setOptions({zIndex:0}),googleMapsFn.fitPolygon(a,map),areaProperty=a,overlays.push(a)},mapListeners:function(){google.maps.event.addDomListener(window,"resize",function(){resize=!0}),map.addListener("idle",function(){resize&&(googleMapsFn.fitPolygon(areaProperty,map),resize=!1)})},showTrajectoryWindow:function(){var e=trajectory.length-1,a=trajectory[0].date,t=trajectory[e].date;$("#trajectory-title").html($.t("trajectoryAnimal.titleSmallWindow",{date:app.htmlEncode(time.extractDate(a))})),render.renderTrajectoryInfo(time.extractTime(a),time.extractTime(t),time.duration(a,t),trajectory.length,googleMapsFn.distanceInMeters(trajectory)),setup.showTrajectory(trajectory)},loadAnimalGeoreference:function(){app.loadingAdd(),$.ajax({url:app.api+"api/geolocation/"+id,type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(e){trajectory=[],e.length>0?($.each(e,function(){trajectory.push({lat:this.coordinate.y,lng:this.coordinate.x,date:this.dateTimeEvent})}),$("#georef-modal").modal("show")):app.notify("warning",$.t("alert.title"),$.t("trajectoryAnimal.alert.noValidCoordinates"))}).fail(function(e){app.ajaxError(e)}).always(function(){app.loadingRemove()})},showTrajectory:function(e){var a=document.getElementById("entry-table").rows[rowSelected].cells[1].innerHTML,t=document.getElementById("entry-table").rows[rowSelected].cells[2].innerHTML;polyline=googleMapsFn.drawPolyline(e,"#FF0000",2,0),googleMapsFn.fitPolygon(polyline,map),overlays.push(polyline),overlays.push(googleMapsFn.drawMarkerAnimal(e[e.length-1],id,"32-boi.png",a,t,moment(e[e.length-1].date).format("DD/MM/YYYY HH:mm:ss")));var o,r=googleMapsFn.drawMarkers(e),n=r.length;for(o=0;o<n;o++)overlays.push(r[o])},backupAllTrajectories:function(){app.loadingAdd(),window.location=app.api+"api/trajectory/backupAllTrajectories/"+localStorage.getItem("property_id")+"/"+app.locale,app.loadingRemove()},downloadData:function(e){window.location=app.api+"api/trajectory/rawdata/"+id+"/"+app.locale+"/"+e},drawTrajectries:function(){var e,a,t,o,r,n=trajectories.length,i=[],l=[];for(e=0;e<n;e++)if(r=[],0!==(t=(i=trajectories[e].geolocations).length)){for(a=0;a<t;a++)r.push({lat:i[a].coordinate.y,lng:i[a].coordinate.x,date:i[a].dateTimeEvent});for(o=trajectories[e].animal.nickName?trajectories[e].animal.nickName:"",o+=o?" - ":"",o+=trajectories[e].animal.code?trajectories[e].animal.code:"",overlays.push(googleMapsFn.drawPolyline(r,"#FFF",2,0)),overlays.push(googleMapsFn.drawMarker(r[r.length-1],"","32-boi.png",o)),t=(l=googleMapsFn.drawMarkers(r)).length,a=0;a<t;a++)overlays.push(l[a])}map=googleMapsFn.drawMap(new google.maps.LatLng(r[0].lat,r[0].lng)),setup.mapListeners()},tableSetup:function(){columns=[{data:"device.code",responsivePriority:3,render:function(e){return e?app.htmlEncode(e):"-"}},{data:"animal.code",responsivePriority:2,render:function(e){return e?app.htmlEncode(e):"-"}},{data:"animal.nickName",responsivePriority:5,render:function(e){return e?app.htmlEncode(e):"-"}},{data:"dateTrajectory",responsivePriority:9,render:function(e){if(e){var a,t=e.split("T");return a="pt-BR"==app.locale?"DD/MM/YYYY":moment.localeData().longDateFormat("L"),app.htmlEncode(app.getDateTime(t[0],a,"YYYY-MM-DD"))}return"-"}},{data:null,responsivePriority:7,render:function(e){return render.renderTrajectoryActions(e.id,e.id)}}],trajectoryUtil.tableLoad(columns)},populateSelects:function(){},init:function(e){console.log("trajectoryAnimal.js"),document.title=$.t("trajectoryAnimal.title"),app=e,this.bindActions(),this.bindModalActions(),this.populateSelects(),this.tableSetup()}};