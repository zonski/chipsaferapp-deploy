var app,table,id=0,entry="saleAnimals",currencyMask="",filtroTeclas=function(a){return a.charCode>=48&&a.charCode<=57},setup={deviceList:[],bindActions:function(){$(".entry-action").click(function(){0==$("#saleList").DataTable().rows().count()?app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saleListEmpty"),!1,!1):entryUtil.validateFields("#entry-add")&&(submitCall=function(a){a&&entryUtil.entryCrud(entry,"submit","","#entry-add")},null==localStorage.getItem("transactionId")?app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saveConfirm"),!0,submitCall):app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saveConfirmUpdate"),!0,submitCall))})},bindTableActions:function(){$('span[data-action="addAnimal"]').click(function(){var a=$(this).data("id"),e=$("#saleList").DataTable(),n=!1;e.rows().every(function(e,t,l){this.data().animalId==a&&(app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.enrolledAnimal"),!1,!1),n=!0)}),n||e.row.add({animalId:a,name:$(this).parents("tr").find("span")[1].innerHTML}).draw()})},tableLoad:function(a,e,n,t){$("#"+t).DataTable({lengthChange:!1,ordering:!1,info:!0,responsive:!1,serverSide:!0,paging:!0,searching:!0,dom:"ftip",language:{url:"locales/"+app.locale+"/translation.json"},ajax:{url:app.api+"api/"+a+"/list"+e,type:"POST",beforeSend:app.setHeaders,error:function(a){app.ajaxError(a)}},preDrawCallback:function(){app.loadingAdd()},drawCallback:function(){setup.bindTableActions(),app.loadingRemove()},initComplete:function(){$('input[type="search"]').attr("placeholder",$.t("entry.search")).attr("maxlength",50),$("#"+t).show()},columns:n})},getColumn:function(a){var e="<span>"+app.htmlEncode(a.code);return null!=a.code&&a.code.length>0?e+=a.nickName?app.htmlEncode(" - "+a.nickName):"":e+=a.nickName?app.htmlEncode(a.nickName):"",e+=a.subSpecies.name?app.htmlEncode(" ("+a.subSpecies.name):"",e+=a.pelage.name?app.htmlEncode(" - "+a.pelage.name):"",e+=" - ",1===a.gender?e+=$.t("animal.fields.genderMale"):2===a.gender&&(e+=$.t("animal.fields.genderFemale")),e+=")",e+="</span>"},tableSetup:function(){var a=[{data:"id",responsivePriority:1,render:function(a){return'<span data-action="addAnimal" data-id="'+a+'" style="cursor:pointer" class="icon icon-plus-alt"></span>'}},{data:null,render:function(a){return setup.getColumn(a)}}];setup.tableLoad(entry,"",a,"animalsList")},formatInputValue:function(a){$("#currency").val();var e=$("#currency").find(":selected").data("locale");return entryUtil.formatStringToCurrency(a,e,$("#currency").val())},populateSelects:function(){$("#currency").empty(),entryUtil.getJsonData("currency/GetAll/","GET").then(function(a){$.each(a,function(a,e){$("#currency").append($("<option>",{value:e.code,text:e.name,"data-mask":e.mask,"data-locale":e.locale,"data-id":e.id}))})}),entryUtil.getJsonData("customersupplier/getallforselling/","GET").then(function(a){$.each(a,function(a,e){$("#client").append($("<option>",{value:e.id,text:e.name,"data-currencyMask":e.currencyMask,"data-currencyCode":e.currencyCode}))})})},sellingTable:function(){$("#saleList").DataTable({paging:!0,searching:!0,info:!1,autoWidth:!1,columns:[{data:"animalId",width:"5%",render:function(a){return'<span data-action="removeAnimal" data-id="'+a+'" style="cursor:pointer" class="glyphicon glyphicon-minus-sign"></span>'}},{data:"name",width:"75%",render:function(a){return"<span>"+a+"</span>"}},{data:"saleValue",width:"20%",render:function(a){return null==a&&(a=""),'<div style="float: right"><input type="text" name="saleValue" class="form-control field required "onkeypress="return filtroTeclas(event)" maxlength="20" value="'+a+'"></div>'}},{data:"id",visible:!1,render:function(a){return app.htmlEncode(a)}}],language:{url:"locales/"+app.locale+"/translation.json"},fixedHeader:{header:!0,footer:!0},drawCallback:function(){}}),$("#excludedItensList").DataTable({searching:!1,paging:!1,info:!1,oLanguage:{sEmptyTable:"",sZeroRecords:""},columns:[{data:"animalId",visible:!1,render:function(a){return'<span data-id="'+a+'"></span>'}},{data:"name",visible:!1,render:function(a){return"<span>"+a+"</span>"}},{data:"saleValue",visible:!1,render:function(a){return null==a&&(a=""),'<input type="text" name="saleValue" value="'+a+'">'}},{data:"id",visible:!1,render:function(a){return app.htmlEncode(a)}}]})},valuesSum:function(){var a=0;$('input[name="saleValue"]').each(function(){var e=$(this).val();e&&(a+=entryUtil.currencyToFloat(e))});var e={minimumFractionDigits:2,style:"currency",currency:$("#currency").val()},n=$("#currency").find(":selected").data("locale");$("#totalSellingByAnimal").html(a.toLocaleString(n,e))},changeInputMask:function(){currencyMask=$("#currency").find(":selected").data("mask"),$('input[name="saleValue"]').mask(currencyMask,{reverse:!0})},loadData:function(a){$.ajax({url:app.api+"api/transaction/"+a,type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(a){if(trans=a,trans){var e=new Date(trans.dateTransaction);$("#sellingDate").val(e.toLocaleDateString(app.locale)),$("#client").val(trans.customerSupplierId),$("#currency").val(trans.currencyCode);var n=$("#saleList").DataTable();a.itens.forEach(function(a){n.row.add({id:a.id,animalId:a.animalId,name:a.animalDescription,saleValue:setup.formatInputValue(a.value)})}),n.draw()}}).fail(function(a){app.ajaxError(a)})},init:function(a){console.log("saleAnimals.js"),document.title=$.t("saleAnimals.title"),app=a,this.bindActions(),this.populateSelects(),this.tableSetup(),this.sellingTable(),$(document).ready(function(){if(null!=localStorage.getItem("transactionId"))setup.loadData(localStorage.getItem("transactionId")),setup.valuesSum(),$("#registerSale").text($.t("saleAnimals.saveEdit"));else{$("#currency").val($("#client").find(":selected").data("currencycode"));var a={minimumFractionDigits:2,style:"currency",currency:$("#currency").val()},e=parseFloat($("#totalSellingByAnimal").html().replace(/^\D+/g,"")),n=$("#currency").find(":selected").data("locale");$("#totalSellingByAnimal").html(e.toLocaleString(n,a))}}),$(document).on("click",'input[name="saleValue"]',function(){setup.changeInputMask()}),$(document).on("focus",'input[name="saleValue"]',function(){setup.changeInputMask()}),$(document).on("click",'span[data-action="removeAnimal"]',function(){var a=$("#saleList").DataTable(),e=$("#excludedItensList").DataTable(),n=$(this).parents("tr")[0],t=$(n).find("td span")[0],l=$(n).find("td span")[1];n.lastElementChild.innerText&&e.row.add({id:n.lastElementChild.innerText,animalId:$(t).data("id"),name:$(l).html(),saleValue:$(n).find("input").val()}).draw(),a.row($(this).parents("tr")).remove().draw(),setup.valuesSum()}),$(document).on("click","#client",function(){currencyMask=$("#client").find(":selected").data("currencymask"),$("#currency").val($("#client").find(":selected").data("currencycode")),$('input[name="saleValue"]').mask(currencyMask,{reverse:!0})}),$(document).on("change","#currency",function(){setup.changeInputMask(),setup.valuesSum()}),$(document).on("blur",'input[name="saleValue"]',function(){$(this).val(setup.formatInputValue($(this).val())),setup.valuesSum()})}};