var app,table,id=0,entry="slaughterSale",currencyMask="",filtroTeclas=function(a){return a.charCode>=48&&a.charCode<=57},setup={deviceList:[],totalSelling:function(){var a=""==$("#txtCarcassYield").val()?0:parseInt($("#txtCarcassYield").val()),t=""==$("#txtValueByAtKg").val()?0:parseFloat(entryUtil.formatStringToDecimal($("#txtValueByAtKg").val())),e=0,n=$("#saleList").DataTable();n.rows().every(function(a,t,n){e+=parseFloat(this.data().weight)});var l=e*(a/100),i=0==n.data().count()?1:n.data().count();$("#totalDeadWeightAverage").html(Math.round(l/i)),$("#totalLiveWeightAverage").html(Math.round(e/i)),$("#totalLiveWeight").html(e);var r={minimumFractionDigits:2,style:"currency",currency:$("#client").find(":selected").data("currencycode")},s=$("#client").find(":selected").data("locale");n.data().count()>0?-1==$("#lblValueByAtKg").text().indexOf("@")?totalSellingByAnimal=t*l:totalSellingByAnimal=t*l/15:totalSellingByAnimal=0;var c=totalSellingByAnimal.toLocaleString(s,r).replace(/[0-9.,\s]/g,""),o=$("#client").find(":selected").data("weightunit");return $("#lblValueByAtKg").text(c.concat("/",o)),$("#totalSellingByAnimal").html(totalSellingByAnimal.toLocaleString(s,r)),totalSellingByAnimal},bindActions:function(){$(".entry-action").click(function(){switch($(this).data("action")){case"addOpen":render.switchTop();break;case"addCancel":render.switchTop(),setup.setSelectValue(!1),setup.showOption(id,!0),id=0;break;case"submit":0==$("#saleList").DataTable().rows().count()?app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saleListEmpty"),!1,!1):entryUtil.validateFields("#entry-add")&&(submitCall=function(a){a&&entryUtil.entryCrud(entry,"submit","","#entry-add")},null==localStorage.getItem("transactionId")?app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saveConfirm"),!0,submitCall):app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.saveConfirmUpdate"),!0,submitCall));break;default:console.log("Entry Action UNDEFINED")}})},bindTableActions:function(){$('span[data-action="addAnimal"]').click(function(){var a=$(this).data("id"),t=$("#saleList").DataTable(),e=!1;if(t.rows().every(function(t,n,l){this.data().animalId==a&&(app.notify("warning",$.t("notify.warning"),$.t("saleAnimals.enrolledAnimal"),!1,!1),e=!0)}),!e){var n=0;if(t.row.add({animalId:a,name:$(this).parents("tr").find("span")[1].innerHTML,weight:$(this).parents("tr").find("td")[2].innerHTML}).draw(),t.rows().every(function(a,t,e){n+=parseFloat(this.data().weight)}),$("#totalLiveWeight").html(n),$("#totalLiveWeightAverage").html(Math.round(n/t.data().count())),""!=$("#txtCarcassYield").val()){var l=parseInt($("#txtCarcassYield").val()),i=n*(l/100);$("#totalDeadWeightAverage").html(Math.round(i/t.data().count()))}setup.totalSelling()}})},tableLoad:function(a,t,e,n){$("#"+n).DataTable({lengthChange:!1,ordering:!1,info:!0,responsive:!1,serverSide:!0,paging:!0,searching:!0,autoWidth:!1,language:{url:"locales/"+app.locale+"/translation.json"},ajax:{url:app.api+"api/"+a+"/list"+t,type:"POST",beforeSend:app.setHeaders,error:function(a){app.ajaxError(a)}},preDrawCallback:function(){app.loadingAdd()},drawCallback:function(){setup.bindTableActions(),app.loadingRemove()},initComplete:function(){$('input[type="search"]').attr("placeholder",$.t("entry.search")).attr("maxlength",50),$("#"+n).show()},columns:e})},getColumn:function(a){var t="<span>"+app.htmlEncode(a.code);return null!=a.code&&a.code.length>0?t+=a.nickName?app.htmlEncode(" - "+a.nickName):"":t+=a.nickName?app.htmlEncode(a.nickName):"",t+=a.subSpecies.name?app.htmlEncode(" ("+a.subSpecies.name):"",t+=a.pelage.name?app.htmlEncode(" - "+a.pelage.name):"",t+=" - ",1===a.gender?t+=$.t("animal.fields.genderMale"):2===a.gender&&(t+=$.t("animal.fields.genderFemale")),(t+=")")+"</span>"},tableSetup:function(){var a=[{data:"id",responsivePriority:1,width:"5%",render:function(a){return'<span data-action="addAnimal" data-id="'+a+'" style="cursor:pointer" class="icon icon-plus-alt"></span>'}},{data:null,width:"80%",render:function(a){return setup.getColumn(a)}},{data:"weight",width:"15%",render:function(a){return a?app.htmlEncode(a):""}}];setup.tableLoad(entry,"",a,"animalsList")},formatInputValue:function(a){$("#client").find(":selected").data("currencycode");var t=$("#client").find(":selected").data("locale");return entryUtil.formatStringToCurrency(a,t,$("#currency").val())},populateSelects:function(){entryUtil.getJsonData("customersupplier/getallforslaughter/","GET").then(function(a){$.each(a,function(a,t){$("#client").append($("<option>",{value:t.id,text:t.name,"data-currencyId":t.currencyId,"data-currencyMask":t.currencyMask,"data-currencyCode":t.currencyCode,"data-weightUnit":t.weightUnit,"data-locale":t.countryLocale}))})})},saleTable:function(){$("#saleList").DataTable({paging:!0,searching:!0,info:!1,autoWidth:!1,columns:[{data:"animalId",width:"5%",render:function(a){return'<span data-action="removeAnimal" data-id="'+a+'" style="cursor:pointer" class="glyphicon glyphicon-minus-sign"></span>'}},{data:"name",width:"80%",render:function(a){return"<span>"+a+"</span>"}},{data:"weight",width:"15%",render:function(a){return null==a&&(a=""),"<div>"+a+"</div>"}},{data:"id",visible:!1,render:function(a){return app.htmlEncode(a)}}],language:{url:"locales/"+app.locale+"/translation.json"},fixedHeader:{header:!0,footer:!0},drawCallback:function(){}}),$("#excludedItensList").DataTable({searching:!1,paging:!1,info:!1,oLanguage:{sEmptyTable:"",sZeroRecords:""},columns:[{data:"animalId",visible:!1,render:function(a){return'<span data-id="'+a+'"></span>'}},{data:"name",visible:!1,render:function(a){return"<span>"+a+"</span>"}},{data:"weightValue",visible:!1,render:function(a){return null==a&&(a=""),'<input type="text" name="weightValue" value="'+a+'">'}},{data:"id",visible:!1,render:function(a){return app.htmlEncode(a)}}]})},changeInputMask:function(){currencyMask=$("#client").find(":selected").data("mask"),$('input[name="saleValue"]').mask(currencyMask,{reverse:!0}),$("#txtValueByAtKg").mask(currencyMask,{reverse:!0})},loadData:function(a){$.ajax({url:app.api+"api/transaction/"+a,type:"GET",async:!1,beforeSend:app.setHeaders}).done(function(a){if(trans=a,trans){var t=new Date(trans.dateTransaction);$("#SlaughterSaleId").val(trans.slaughterSaleId),$("#sellingDate").val(t.toLocaleDateString(app.locale)),$("#client").val(trans.customerSupplierId);var e=$("#client").find(":selected").data("currencycode"),n=$("#client").find(":selected").data("locale"),l={minimumFractionDigits:2,style:"currency",currency:e},i=trans.slaughterSale.valueByAtKg.toLocaleString(n,l);$("#txtValueByAtKg").val(i.replace(/^\D+/g,"")),$("#txtCarcassYield").val(trans.slaughterSale.carcassYield),$("#SlaughterSaleId").val(trans.slaughterSale.id);var r=$("#saleList").DataTable(),s=0;a.itens.forEach(function(a){r.row.add({id:a.id,animalId:a.animalId,name:a.animalDescription,weight:a.weight}),s+=a.weight}),r.draw(),$("#totalLiveWeight").html(s),setup.totalSelling()}}).fail(function(a){app.ajaxError(a)})},init:function(a){console.log("slaughterSale.js"),document.title=$.t("slaughterSale.title"),app=a,this.bindActions(),this.populateSelects(),this.tableSetup(),this.saleTable(),$(document).ready(function(){null!=localStorage.getItem("transactionId")&&(setup.loadData(localStorage.getItem("transactionId")),$("#registersale").text($.t("saleAnimals.saveEdit"))),setup.totalSelling(),currencyMask=$("#client").find(":selected").data("currencymask"),$("#txtCarcassYield").mask("00"),$("#txtValueByAtKg").mask(currencyMask,{reverse:!0})}),$(document).on("click",'input[name="saleValue"]',function(){setup.changeInputMask()}),$(document).on("click",'span[data-action="removeAnimal"]',function(){var a=$("#saleList").DataTable(),t=$("#excludedItensList").DataTable(),e=$(this).parents("tr")[0],n=$(e).find("td span")[0],l=$(e).find("td span")[1];e.lastElementChild.innerText&&t.row.add({id:e.lastElementChild.innerText,animalId:$(n).data("id"),name:$(l).html(),weightValue:$(e).find("input").val()}).draw(),a.row($(this).parents("tr")).remove().draw();var i=0;a.rows().every(function(a,t,e){i+=parseFloat(this.data().weight)}),$("#totalLiveWeight").html(i);var r=0==a.data().count()?1:a.data().count();if($("#totalLiveWeightAverage").html(Math.round(i/r)),""!=$("#txtCarcassYield").val()){var s=parseInt($("#txtCarcassYield").val()),c=i*(s/100);$("#totalDeadWeightAverage").html(Math.round(c/r))}}),$(document).on("click","#client",function(){currencyMask=$("#client").find(":selected").data("currencymask"),$("#txtCarcassYield").mask("00"),$("#txtValueByAtKg").mask(currencyMask,{reverse:!0})}),$(document).on("change","#client",function(){setup.changeInputMask(),setup.totalSelling()}),$(document).on("blur","#txtCarcassYield",function(){setup.totalSelling()}),$(document).on("blur","#txtValueByAtKg",function(){setup.totalSelling()})}};